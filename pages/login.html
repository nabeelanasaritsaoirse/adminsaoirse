<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Panel - Login</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>

    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css"/>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="../assets/css/style.css" />

    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .login-container {
            max-width: 450px;
            width: 100%;
            padding: 20px;
        }
        .login-card {
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        .login-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px 15px 0 0;
            padding: 30px;
            text-align: center;
        }
    </style>
</head>

<body>
    <div class="login-container">
        <div class="card login-card">
            <div class="login-header">
                <i class="bi bi-shield-lock fs-1"></i>
                <h3 class="mt-2">Admin Panel</h3>
                <p class="mb-0">Sign in to your account</p>
            </div>

            <div class="card-body p-4">
                <form id="loginForm">
                    <div class="mb-3">
                        <label class="form-label">
                            <i class="bi bi-envelope"></i> Email Address
                        </label>
                        <input type="email" class="form-control" id="email" required />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">
                            <i class="bi bi-lock"></i> Password
                        </label>
                        <input type="password" class="form-control" id="password" required />
                    </div>

                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="bi bi-box-arrow-in-right"></i> Sign In
                        </button>
                    </div>
                </form>
            </div>

            <div class="card-footer text-center text-muted">
                <small>¬© 2024 Admin Panel. All rights reserved.</small>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <!-- ‚≠ê CONFIG MUST LOAD FIRST - CRITICAL DEPENDENCY -->
    <script src="../assets/js/config.js"></script>

    <!-- ‚≠ê Wait for config to load, then initialize login handler -->
    <script>
        // Safety guard: Ensure config is ready before running login logic
        function initializeLoginHandler() {
            // Check 1: Verify BASE_URL is available
            if (!window.BASE_URL) {
                console.error("‚ùå CRITICAL: BASE_URL not initialized after config.js loaded");
                console.error("   Current window.BASE_URL:", window.BASE_URL);
                document.getElementById("loginForm").style.display = "none";
                alert("‚ö†Ô∏è Configuration Error\n\nBase URL is not initialized. This is a server configuration issue.\n\nPlease:\n1. Refresh the page (Ctrl+F5)\n2. Clear browser cache\n3. Contact support if problem persists");
                return false;
            }

            // Check 2: Verify API_CONFIG is available
            if (!window.API_CONFIG || !window.API_CONFIG.endpoints) {
                console.error("‚ùå CRITICAL: API_CONFIG not available");
                alert("Configuration missing. Please refresh the page.");
                return false;
            }

            console.log("‚úÖ Configuration loaded successfully");
            console.log("   BASE_URL:", window.BASE_URL);
            console.log("   API Endpoint:", window.API_CONFIG.endpoints.auth.adminLogin);

            // Setup login form handler
            document.getElementById("loginForm").addEventListener("submit", handleLoginSubmit);
            return true;
        }

        // Main login handler
        async function handleLoginSubmit(e) {
            e.preventDefault();

            const email = document.getElementById("email").value.trim();
            const password = document.getElementById("password").value.trim();

            // Validate inputs
            if (!email || !password) {
                alert("Please enter both email and password");
                return;
            }

            try {
                // ‚≠ê Safety Check: Verify window.BASE_URL exists before making request
                if (!window.BASE_URL) {
                    console.error("‚ùå BASE_URL lost during form submission");
                    alert("Configuration error. Please reload the page.");
                    return;
                }

                // Build login URL using window.BASE_URL (global, safe)
                const loginURL = window.BASE_URL + window.API_CONFIG.endpoints.auth.adminLogin;
                
                console.log("üì° Sending login request to:", loginURL);

                const response = await fetch(loginURL, {
                    method: "POST",
                    headers: { 
                        "Content-Type": "application/json",
                        "Accept": "application/json"
                    },
                    body: JSON.stringify({ email, password }),
                });

                console.log("üì• Response status:", response.status);

                const result = await response.json();

                if (!response.ok) {
                    console.error("‚ùå Login failed:", result);
                    alert(result.message || `Login failed (${response.status}). Please check your credentials.`);
                    return;
                }

                if (!result.success || !result.data || !result.data.accessToken) {
                    console.error("‚ùå Invalid response format:", result);
                    alert(result.message || "Login failed. Please try again.");
                    return;
                }

                // ‚úÖ Login successful - Store token and user data
                console.log("‚úÖ Login successful");
                localStorage.setItem("epi_admin_token", result.data.accessToken);
                localStorage.setItem("authToken", result.data.accessToken);
                localStorage.setItem("epi_admin_user", JSON.stringify(result.data));

                // Redirect to dashboard
                window.location.href = "dashboard.html";

            } catch (err) {
                console.error("‚ùå Login request error:", err);
                
                if (err instanceof TypeError && err.message.includes("Failed to fetch")) {
                    alert("Unable to connect to server.\n\nPlease check:\n‚Ä¢ Your internet connection\n‚Ä¢ The server is running\n‚Ä¢ Your firewall settings");
                } else {
                    alert(`Error: ${err.message || "Unknown error during login"}`);
                }
            }
        }

        // ‚≠ê Initialize login handler when DOM is ready
        // This ensures config.js has already executed
        if (document.readyState === "loading") {
            document.addEventListener("DOMContentLoaded", initializeLoginHandler);
        } else {
            // DOM already loaded (script executed late)
            initializeLoginHandler();
        }
    </script>
</body>
</html>
