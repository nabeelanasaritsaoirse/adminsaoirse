name: ğŸ§© GitHub Conflict Management
run-name: "ğŸš€ Conflict Check triggered by ${{ github.actor }} on PR #${{ github.event.pull_request.number }}"

permissions:
  contents: read
  pull-requests: write
  issues: write

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  detect_conflict:
    name: ğŸ” Detect Merge Conflicts
    runs-on: ubuntu-latest

    outputs:
      has_conflict: ${{ steps.detect.outputs.conflict_found }}
      commit_sha: ${{ steps.get_commit.outputs.sha }}
      commit_author: ${{ steps.get_commit.outputs.author }}
      base_branch: ${{ steps.get_branch.outputs.base }}
      head_branch: ${{ steps.get_branch.outputs.head }}

    steps:
      - name: ğŸ“ Check merge conflict status
        id: detect
        uses: eps1lon/actions-pr-check-merge-conflict@v2
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ“Œ Get commit info
        id: get_commit
        run: |
          echo "sha=$(jq -r '.pull_request.head.sha' <<< '${{ toJson(github.event) }}')" >> $GITHUB_OUTPUT
          echo "author=$(jq -r '.pull_request.head.user.login' <<< '${{ toJson(github.event) }}')" >> $GITHUB_OUTPUT

      - name: ğŸ“Œ Get branch info
        id: get_branch
        run: |
          echo "base=$(jq -r '.pull_request.base.ref' <<< '${{ toJson(github.event) }}')" >> $GITHUB_OUTPUT
          echo "head=$(jq -r '.pull_request.head.ref' <<< '${{ toJson(github.event) }}')" >> $GITHUB_OUTPUT

  create_issue:
    name: ğŸ“ Create Merge Conflict Issue
    runs-on: ubuntu-latest
    needs: detect_conflict
    if: needs.detect_conflict.outputs.has_conflict == 'true'

    steps:
      - name: ğŸ“„ Generate Issue Content
        id: issue
        run: |
          cat > conflict_issue.md << 'EOF'
          ## âš ï¸ Merge Conflict Detected

          A merge conflict has been detected in **PR #${{ github.event.pull_request.number }}**.

          ### ğŸ”€ Commit Causing Conflict
          - **Commit SHA:** `${{ needs.detect_conflict.outputs.commit_sha }}`
          - **Author:** **${{ needs.detect_conflict.outputs.commit_author }}**

          ### ğŸ”§ Branch Details
          - **Base Branch:** `${{ needs.detect_conflict.outputs.base_branch }}`
          - **Your Branch:** `${{ needs.detect_conflict.outputs.head_branch }}`

          ---

          ## ğŸ“Œ Steps to Fix

          Run these commands:

          ```bash
          git checkout ${{ needs.detect_conflict.outputs.head_branch }}
          git pull
          git merge origin/${{ needs.detect_conflict.outputs.base_branch }}
          # Resolve conflicts locally
          git add .
          git commit -m "fix: resolve merge conflicts"
          git push
          ```

          ---

          This issue was automatically generated.
          EOF

      - name: ğŸ§¾ Create GitHub Issue
        uses: peter-evans/create-issue@v4
        with:
          title: "âš ï¸ Merge Conflict in PR #${{ github.event.pull_request.number }}"
          assignees: ${{ needs.detect_conflict.outputs.commit_author }}
          labels: "âš ï¸ merge conflict, automation"
          body-file: conflict_issue.md
